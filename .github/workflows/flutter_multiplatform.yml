name: Flutter Multi-Platform CI

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: flutter-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: "3.38.4"

jobs:
  quality:
    name: Quality (does not fail workflow)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Pub get (enforce lockfile)
        run: flutter pub get --enforce-lockfile

      - name: Codegen (build_runner)
        continue-on-error: true
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Format check
        continue-on-error: true
        run: dart format --output=none --set-exit-if-changed .

      - name: Analyze
        continue-on-error: true
        run: flutter analyze

      - name: Custom lint
        continue-on-error: true
        run: dart run custom_lint

      - name: Test
        continue-on-error: true
        run: flutter test

  build:
    name: Build & Package (${{ matrix.platform }}) (never fails)
    needs: quality
    if: github.event_name != 'pull_request'
    runs-on: ${{ matrix.os }}
    timeout-minutes: 70
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: android
            os: ubuntu-latest
          - platform: ios
            os: macos-latest
          - platform: macos
            os: macos-latest
          - platform: windows
            os: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Pub get (enforce lockfile)
        run: flutter pub get --enforce-lockfile

      - name: Codegen (build_runner)
        continue-on-error: true
        run: dart run build_runner build --delete-conflicting-outputs

      # -------- Metadata (Linux/macOS) --------
      - name: Read app metadata (unix)
        if: matrix.platform != 'windows'
        shell: bash
        run: |
          APP_NAME=$(grep '^name:' pubspec.yaml | awk '{print $2}' | tr -d '"' | tr -d "'")
          APP_VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' | tr -d '"' | tr -d "'")
          # filename-safe: "1.0.0+1" -> "1.0.0_1"
          APP_VERSION_SAFE="${APP_VERSION//+/_}"
          SHA7=${GITHUB_SHA::7}
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
          echo "APP_VERSION=$APP_VERSION_SAFE" >> $GITHUB_ENV
          echo "BUILD_TAG=${APP_NAME}-${APP_VERSION_SAFE}-${SHA7}" >> $GITHUB_ENV

      # -------- Metadata (Windows) --------
      - name: Read app metadata (windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          $pub = Get-Content pubspec.yaml -Raw
          $name = ([regex]::Match($pub, '^\s*name:\s*(.+)\s*$', 'Multiline')).Groups[1].Value.Trim().Trim('"').Trim("'")
          $ver  = ([regex]::Match($pub, '^\s*version:\s*(.+)\s*$', 'Multiline')).Groups[1].Value.Trim().Trim('"').Trim("'")
          $verSafe = $ver.Replace('+','_')
          $sha7 = $env:GITHUB_SHA.Substring(0,7)
          Add-Content -Path $env:GITHUB_ENV -Value "APP_NAME=$name"
          Add-Content -Path $env:GITHUB_ENV -Value "APP_VERSION=$verSafe"
          Add-Content -Path $env:GITHUB_ENV -Value "BUILD_TAG=$name-$verSafe-$sha7"

      # ===================== ANDROID =====================
      - name: Set up Java (Android)
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # Writes:
      # - android/app/upload-keystore.jks (or android/app/ci-keystore.jks)
      # - android/key.properties  (IMPORTANT: storeFile is relative to android/app)
      - name: Prepare Android signing (use secrets, else generate CI keystore)
        if: matrix.platform == 'android'
        shell: bash
        env:
          KS_B64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KS_PASS: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASS: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -e
          mkdir -p android/app

          if [ -n "$KS_B64" ] && [ -n "$KS_PASS" ] && [ -n "$KEY_ALIAS" ] && [ -n "$KEY_PASS" ]; then
            echo "Using repository secrets keystore"
            echo "$KS_B64" | base64 --decode > android/app/upload-keystore.jks
            cat > android/key.properties <<EOF
storePassword=$KS_PASS
keyPassword=$KEY_PASS
keyAlias=$KEY_ALIAS
storeFile=upload-keystore.jks
EOF
          else
            echo "Secrets missing -> generating CI keystore (release builds will work, NOT Play Store suitable)"
            CI_PASS="ci-pass-123456"
            CI_ALIAS="ci"
            keytool -genkeypair -v \
              -keystore android/app/ci-keystore.jks \
              -storepass "$CI_PASS" \
              -keypass "$CI_PASS" \
              -alias "$CI_ALIAS" \
              -dname "CN=CI,O=CI,L=CI,S=CI,C=US" \
              -keyalg RSA -keysize 2048 -validity 10000

            cat > android/key.properties <<EOF
storePassword=$CI_PASS
keyPassword=$CI_PASS
keyAlias=$CI_ALIAS
storeFile=ci-keystore.jks
EOF
          fi

      - name: Build Android (release APK + release AAB + debug APK)
        if: matrix.platform == 'android'
        continue-on-error: true
        shell: bash
        run: |
          flutter build apk --release
          flutter build appbundle --release
          flutter build apk --debug

      - name: Package Android (rename to dist/)
        if: matrix.platform == 'android'
        continue-on-error: true
        shell: bash
        run: |
          mkdir -p dist

          # release apk
          if [ -f build/app/outputs/flutter-apk/app-release.apk ]; then
            cp build/app/outputs/flutter-apk/app-release.apk "dist/${BUILD_TAG}-android-release.apk"
          fi

          # debug apk
          if [ -f build/app/outputs/flutter-apk/app-debug.apk ]; then
            cp build/app/outputs/flutter-apk/app-debug.apk "dist/${BUILD_TAG}-android-debug.apk"
          fi

          # release aab
          if [ -f build/app/outputs/bundle/release/app-release.aab ]; then
            cp build/app/outputs/bundle/release/app-release.aab "dist/${BUILD_TAG}-android-release.aab"
          fi

          ls -la dist || true

      - name: Upload Android artifacts
        if: matrix.platform == 'android'
        uses: actions/upload-artifact@v4
        with:
          name: android-dist
          if-no-files-found: warn
          path: dist/*

      # ===================== iOS =====================
      - name: Build iOS (release, no codesign)
        if: matrix.platform == 'ios'
        continue-on-error: true
        run: flutter build ios --release --no-codesign

      - name: Package iOS (unsigned Runner.app zip)
        if: matrix.platform == 'ios'
        continue-on-error: true
        shell: bash
        run: |
          mkdir -p dist
          if [ -d build/ios/iphoneos/Runner.app ]; then
            cd build/ios/iphoneos
            ditto -c -k --sequesterRsrc --keepParent Runner.app Runner.app.zip
            mv Runner.app.zip "${GITHUB_WORKSPACE}/dist/${BUILD_TAG}-ios-unsigned-release.zip"
          else
            echo "Runner.app not found; skipping"
          fi
          ls -la dist || true

      - name: Upload iOS artifacts
        if: matrix.platform == 'ios'
        uses: actions/upload-artifact@v4
        with:
          name: ios-dist
          if-no-files-found: warn
          path: dist/*

      # ===================== macOS =====================
      - name: Build macOS (release)
        if: matrix.platform == 'macos'
        continue-on-error: true
        run: flutter build macos --release

      - name: Package macOS (.app zip)
        if: matrix.platform == 'macos'
        continue-on-error: true
        shell: bash
        run: |
          mkdir -p dist
          if [ -d build/macos/Build/Products/Release ]; then
            cd build/macos/Build/Products/Release
            APP="$(ls -1 *.app 2>/dev/null | head -n 1)"
            if [ -n "$APP" ]; then
              ditto -c -k --sequesterRsrc --keepParent "$APP" macos.app.zip
              mv macos.app.zip "${GITHUB_WORKSPACE}/dist/${BUILD_TAG}-macos-release.zip"
            else
              echo "No .app found; skipping"
            fi
          else
            echo "macOS Release folder not found; skipping"
          fi
          ls -la dist || true

      - name: Upload macOS artifacts
        if: matrix.platform == 'macos'
        uses: actions/upload-artifact@v4
        with:
          name: macos-dist
          if-no-files-found: warn
          path: dist/*

      # ===================== Windows =====================
      - name: Build Windows (release)
        if: matrix.platform == 'windows'
        continue-on-error: true
        run: flutter build windows --release

      - name: Package Windows (zip Release folder)
        if: matrix.platform == 'windows'
        continue-on-error: true
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          if (Test-Path "build\windows\x64\runner\Release") {
            Compress-Archive -Path "build\windows\x64\runner\Release\*" -DestinationPath "dist\$env:BUILD_TAG-windows-release.zip" -Force
          } else {
            Write-Host "Windows Release folder not found; skipping"
          }
          Get-ChildItem dist -Force | Format-Table -AutoSize

      - name: Upload Windows artifacts
        if: matrix.platform == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: windows-dist
          if-no-files-found: warn
          path: dist/*

